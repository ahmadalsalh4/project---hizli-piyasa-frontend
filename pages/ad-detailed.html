<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Details - Hızlı Piyasa</title>
    <link rel="stylesheet" href="../css/ad-detailed.css">
</head>
<body>
    <header>
        <div id="header"></div>
    </header>

    <main class="ad-details-container">
        <div class="ad-images">
            <div class="main-image">
                <img id="main-image" src="../images/placeholder-image.jpg" alt="Main product image">
            </div>
            <div class="thumbnail-container" id="thumbnails"></div>
        </div>

        <div class="ad-info">
            <h1 id="ad-title">Product Title</h1>
            <div class="price-container">
                <span id="ad-price">₺0.00</span>
                <span id="original-price" class="original-price"></span>
            </div>
            <div class="ad-meta">
                <span id="ad-date">Posted: Today</span>
                <span id="ad-views">Views: 0</span>
                <span id="ad-location">Location: Unknown</span>
            </div>
            <div class="ad-description">
                <h3>Description</h3>
                <p id="ad-description-text">No description available.</p>
            </div>
            <div class="seller-info">
                <h3>Seller Information</h3>
                <div class="seller-details">
                    <img id="seller-avatar" src="../images/default-avatar.jpg" alt="Seller avatar">
                    <div>
                        <h4 id="seller-name">Seller Name</h4>
                        <p id="seller-rating">Rating: Not rated</p>
                        <p id="seller-join-date">Member since: Unknown</p>
                    </div>
                </div>
                <button id="contact-seller" class="btn-primary">Contact Seller</button>
            </div>
        </div>
    </main>

    <section class="similar-ads">
        <h2>Similar Ads</h2>
        <div class="ads-grid" id="similar-ads"></div>
    </section>

    <footer>
        <div id="footer"></div>
    </footer>

    <script type="module">
        import { LoadHeader, LoadFooter, UpdateProfileState } from "../js/util.js";
        import { initCardInteractions } from "../js/cardInteractions.js";

        document.addEventListener("DOMContentLoaded", async () => {
            // Load common components
            await LoadHeader("header");
            await UpdateProfileState("header");
            await LoadFooter("footer");
            
            // Initialize card interactions for similar ads
            initCardInteractions();
            
            // Get ad ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const adId = urlParams.get('id');
            
            if (adId) {
                // Fetch and display ad details
                await loadAdDetails(adId);
                // Load similar ads
                await loadSimilarAds(adId);
            } else {
                console.error("No ad ID found in URL");
                // Redirect to homepage or show error
                window.location.href = "/index.html";
            }
        });

        async function loadAdDetails(adId) {
            try {
                const response = await fetch(`http://localhost:5000/api/ads/${adId}`);
                if (!response.ok) throw new Error('Ad not found');
                
                const ad = await response.json();
                
                // Update the page with ad data
                document.getElementById('ad-title').textContent = ad.title;
                document.getElementById('ad-price').textContent = `₺${ad.price.toFixed(2)}`;
                document.getElementById('ad-description-text').textContent = ad.description;
                document.getElementById('ad-date').textContent = `Posted: ${new Date(ad.createdAt).toLocaleDateString()}`;
                document.getElementById('ad-location').textContent = `Location: ${ad.location || 'Not specified'}`;
                
                // Handle images
                const mainImage = document.getElementById('main-image');
                const thumbnailsContainer = document.getElementById('thumbnails');
                
                if (ad.images && ad.images.length > 0) {
                    mainImage.src = ad.images[0];
                    thumbnailsContainer.innerHTML = '';
                    
                    ad.images.forEach((img, index) => {
                        const thumb = document.createElement('img');
                        thumb.src = img;
                        thumb.alt = `Thumbnail ${index + 1}`;
                        thumb.classList.add('thumbnail');
                        thumb.addEventListener('click', () => {
                            mainImage.src = img;
                        });
                        thumbnailsContainer.appendChild(thumb);
                    });
                }
                
                // Handle seller info
                const sellerResponse = await fetch(`http://localhost:5000/api/users/${ad.sellerId}`);
                if (sellerResponse.ok) {
                    const seller = await sellerResponse.json();
                    document.getElementById('seller-name').textContent = seller.name || seller.username;
                    document.getElementById('seller-avatar').src = seller.avatar || '../images/default-avatar.jpg';
                    document.getElementById('seller-join-date').textContent = `Member since: ${new Date(seller.createdAt).toLocaleDateString()}`;
                }
                
            } catch (error) {
                console.error('Error loading ad details:', error);
                // Show error message to user
            }
        }

        async function loadSimilarAds(adId) {
            try {
                // This would ideally use the current ad's category to find similar ones
                const response = await fetch(`http://localhost:5000/api/ads?limit=4&exclude=${adId}`);
                if (!response.ok) throw new Error('Could not load similar ads');
                
                const similarAds = await response.json();
                const container = document.getElementById('similar-ads');
                
                if (similarAds.length > 0) {
                    container.innerHTML = similarAds.map(ad => `
                        <div class="ad-card" data-ad-id="${ad.id}">
                            <a href="/pages/ad-detailed.html?id=${ad.id}" class="ad-card-link">
                                <img src="${ad.images?.[0] || '../images/placeholder-image.jpg'}" alt="${ad.title}">
                                <div class="ad-info">
                                    <h3>${ad.title}</h3>
                                    <p class="price">₺${ad.price.toFixed(2)}</p>
                                    <p class="location">${ad.location || 'Unknown location'}</p>
                                </div>
                            </a>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No similar ads found</p>';
                }
            } catch (error) {
                console.error('Error loading similar ads:', error);
                document.getElementById('similar-ads').innerHTML = '<p>Could not load similar ads</p>';
            }
        }

        // Contact seller button functionality
        document.addEventListener('click', (e) => {
            if (e.target.id === 'contact-seller') {
                // Implement contact functionality
                alert('Contact form would appear here');
            }
        });
    </script>
</body>
</html>